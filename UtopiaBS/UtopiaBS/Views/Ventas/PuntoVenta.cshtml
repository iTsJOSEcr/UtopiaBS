@model UtopiaBS.ViewModels.VentaViewModel
@{
    ViewBag.Title = "Punto de Venta";
}

<!-- Bootstrap & Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

<div class="container py-4">

    <div class="row g-4">
        <!-- PANEL IZQUIERDO -->
        <div class="col-lg-5">
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
                <div class="card-header text-white fw-semibold" style="background-color:#1B263B;">
                    <ul class="nav nav-tabs card-header-tabs border-0">
                        <li class="nav-item">
                            <a class="nav-link active fw-semibold text-white" data-bs-toggle="tab" href="#tabProductos">Productos</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link fw-semibold text-white" data-bs-toggle="tab" href="#tabServicios">Servicios</a>
                        </li>
                    </ul>
                </div>

                <div class="card-body" style="background-color:#F8F9FA;">
                    <div class="tab-content">
                        <!-- PRODUCTOS -->
                        <div class="tab-pane fade show active" id="tabProductos">
                            <div class="input-group mb-3">
                                <input type="text" id="txtBuscarProducto" class="form-control form-control-lg" placeholder="Buscar producto...">
                                <button type="button" id="btnBuscarProducto" class="btn btn-lg fw-semibold text-dark btn-buscar">
                                    <i class="bi bi-search me-1"></i> Buscar
                                </button>
                            </div>
                            <ul id="resultadoBusquedaProductos" class="list-group list-group-flush"></ul>
                        </div>

                        <!-- SERVICIOS -->
                        <div class="tab-pane fade" id="tabServicios">
                            <div class="input-group mb-3">
                                <input type="text" id="txtBuscarServicio" class="form-control form-control-lg" placeholder="Buscar servicio...">
                                <button type="button" id="btnBuscarServicio" class="btn btn-lg fw-semibold text-dark btn-buscar">
                                    <i class="bi bi-search me-1"></i> Buscar
                                </button>
                            </div>
                            <ul id="resultadoBusquedaServicios" class="list-group list-group-flush"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PANEL DERECHO: CARRITO -->
        <div class="col-lg-7">
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
                <div class="card-header text-white fw-semibold" style="background-color:#1B263B;">
                    <i class="bi bi-cart4 me-2"></i> Módulo de Gestión de Ventas
                </div>

                <div class="card-body bg-white">

                    <!-- 🔹 BUSCAR / SELECCIONAR CLIENTE (INLINE) -->
                    <div class="mb-4 p-3 border rounded bg-light">
                        <h5 class="fw-semibold mb-3">
                            <i class="bi bi-person-badge me-1"></i> Cliente
                        </h5>
                        <div class="row g-2 align-items-end">
                            <div class="col-md-6">
                                <label for="txtBuscarCliente" class="form-label">Nombre o cédula</label>
                                <input type="text" id="txtBuscarCliente" class="form-control" placeholder="Ej: 101010101 o Ana" />
                            </div>
                            <div class="col-md-3">
                                <button type="button" id="btnBuscarCliente" class="btn btn-primary w-100 mt-4">
                                    <i class="bi bi-search"></i> Buscar
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button type="button" id="btnLimpiarClientes" class="btn btn-outline-secondary w-100 mt-4">
                                    Limpiar
                                </button>
                            </div>
                        </div>
                        <div id="resultadoClientes" class="mt-3"></div>
                    </div>

                    <!-- 🔹 CARRITO -->
                    <div id="carritoContainer">
                        @Html.Partial("_CarritoParcial", Model)
                    </div>

                    <div class="d-grid mt-3">
                        <button class="btn btn-lg text-dark fw-semibold border-0" id="btnFinalizarVenta" style="background-color:#FFD60A;">
                            <i class="bi bi-check-circle-fill me-2"></i> Finalizar Venta
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL CONFIRMAR -->
<div class="modal fade" id="modalConfirmarVenta" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header text-dark" style="background-color:#FFD60A;">
                <h5 class="modal-title fw-bold"><i class="bi bi-exclamation-circle-fill me-2"></i>Confirmar Venta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <p class="fs-5 text-secondary">¿Desea finalizar esta venta?</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="btnConfirmarVenta" class="btn text-dark fw-semibold px-4" style="background-color:#FFD60A;">Sí, finalizar</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL MENSAJE -->
<div class="modal fade" id="modalMensajeVenta" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header text-white" style="background-color:#1B263B;">
                <h5 class="modal-title fw-bold"><i class="bi bi-info-circle-fill me-2"></i>Resultado</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center" id="mensajeVentaBody"></div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn text-dark fw-semibold px-4" style="background-color:#FFD60A;" data-bs-dismiss="modal">Aceptar</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    var urlBuscarProducto = '@Url.Action("BuscarProducto", "Ventas")';
    var urlBuscarServicio = '@Url.Action("BuscarServicio", "Ventas")';
    var urlAgregarProducto = '@Url.Action("AgregarAlCarrito", "Ventas")';
    var urlAgregarServicio = '@Url.Action("AgregarServicioAlCarrito", "Ventas")';
    var urlCarritoParcial = '@Url.Action("CarritoParcial", "Ventas")';
    var urlActualizarLinea = '@Url.Action("ActualizarLinea", "Ventas")';
    var urlEliminarLinea = '@Url.Action("EliminarLinea", "Ventas")';
    var urlAplicarCupon = '@Url.Action("AplicarCupon", "Ventas")';
    var urlQuitarCupon = '@Url.Action("QuitarCupon", "Ventas")';
    var urlFinalizarVenta = '@Url.Action("FinalizarVenta", "Ventas")';

    // 🔹 Cliente
    var urlBuscarCliente = '@Url.Action("BuscarCliente", "Ventas")';
    var urlSeleccionarCliente = '@Url.Action("SeleccionarCliente", "Ventas")';
    var urlQuitarClienteVenta = '@Url.Action("QuitarCliente", "Ventas")';

    function formatCurrency(value) {
        return value?.toLocaleString('es-CR', { style: 'currency', currency: 'CRC', minimumFractionDigits: 0 }) || '₡0';
    }

    function refreshCarritoPartial(callback) {
        $('#carritoContainer').load(urlCarritoParcial, function () {
            attachCarritoEvents();
            if (typeof callback === 'function') callback();
        });
    }

    function attachCarritoEvents() {
        // Eliminar línea
        $('#carritoContainer').off('click', '.btn-eliminar').on('click', '.btn-eliminar', function () {
            var id = $(this).closest('tr').data('id');
            var esServicio = $(this).closest('tr').data('esservicio') === true || $(this).closest('tr').data('esservicio') === 'true';
            eliminarLinea(id, esServicio);
        });

        // Cambiar cantidad
        $('#carritoContainer').off('change', 'input[data-id]').on('change', 'input[data-id]', function () {
            onCantidadChange(this);
        });

        // Cupón
        $('#carritoContainer').off('click', '#btnAplicarCupon').on('click', '#btnAplicarCupon', aplicarCupon);
        $('#carritoContainer').off('click', '#btnQuitarCupon').on('click', '#btnQuitarCupon', quitarCupon);

        // Quitar cliente
        $('#carritoContainer').off('click', '#btnQuitarCliente').on('click', '#btnQuitarCliente', function () {
            $.post(urlQuitarClienteVenta, {}, function (res) {
                if (res && res.success) {
                    refreshCarritoPartial();
                }
            });
        });
    }

    // Buscar productos
    $('#btnBuscarProducto').on('click', function () {
        var termino = $('#txtBuscarProducto').val();
        $.get(urlBuscarProducto, { termino: termino }, function (res) {
            var $list = $('#resultadoBusquedaProductos').empty();
            if (!res || !res.length) {
                $list.append('<li class="list-group-item text-center text-muted">No se encontraron productos.</li>');
                return;
            }
            res.forEach(function (p) {
                var item = `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>${p.Nombre} - ${formatCurrency(p.PrecioUnitario)} <small class="text-muted">(Stock: ${p.CantidadStock})</small></span>
                        <button class="btn btn-sm text-dark fw-semibold btn-agregar" style="background-color:#FFD60A;"
                                onclick="agregarProducto(${p.IdProducto}, '${p.Nombre.replace("'", "\\'")}', ${p.PrecioUnitario}, ${p.CantidadStock})">
                            <i class='bi bi-plus-lg'></i> Agregar
                        </button>
                    </li>`;
                $list.append(item);
            });
        });
    });

    // Buscar servicios
    $('#btnBuscarServicio').on('click', function () {
        var termino = $('#txtBuscarServicio').val();
        $.get(urlBuscarServicio, { termino: termino }, function (res) {
            var $list = $('#resultadoBusquedaServicios').empty();
            if (!res || !res.length) {
                $list.append('<li class="list-group-item text-center text-muted">No se encontraron servicios.</li>');
                return;
            }
            res.forEach(function (s) {
                var item = `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>${s.Nombre} - ${formatCurrency(s.PrecioUnitario)}</span>
                        <button class="btn btn-sm text-dark fw-semibold btn-agregar" style="background-color:#FFD60A;"
                                onclick="agregarServicio(${s.IdServicio}, '${s.Nombre.replace("'", "\\'")}', ${s.PrecioUnitario})">
                            <i class='bi bi-plus-lg'></i> Agregar
                        </button>
                    </li>`;
                $list.append(item);
            });
        });
    });

    function agregarProducto(idProducto, nombre, precio, stock) {
        $.post(urlAgregarProducto, { idProducto }, function (res) {

            if (res && res.success) {
                refreshCarritoPartial();
            } else {
                const msg = res && res.mensaje
                    ? "⚠️ " + res.mensaje
                    : "No se pudo agregar el producto.";
                mostrarMensajeVenta(msg);
            }

        }).fail(function () {
            mostrarMensajeVenta("Ocurrió un error al conectar con el servidor.");
        });
    }



    function agregarServicio(idServicio, nombre, precio) {
        $.post(urlAgregarServicio, { idServicio, nombre, precioUnitario: precio }, function (res) {
            if (res && res.success) refreshCarritoPartial();
        });
    }

    function onCantidadChange(input) {
        var $input = $(input);
        var id = $input.data('id');
        var esServicio = $input.data('esservicio') === true || $input.data('esservicio') === 'true';
        var cantidad = parseInt($input.val()) || 1;
        $.post(urlActualizarLinea, { idProducto: id, cantidad, esServicio }, function () {
            refreshCarritoPartial();
        });
    }

    function eliminarLinea(idProducto, esServicio) {
        $.post(urlEliminarLinea, { idProducto, esServicio }, function (res) {
            if (res && res.success) refreshCarritoPartial();
        });
    }

    function aplicarCupon() {
        var codigo = $('#txtCupon').val();
        $.post(urlAplicarCupon, { codigo }, function (res) {
            if (res && res.success) {
                refreshCarritoPartial(() => $('#mensajeCupon').text(res.mensaje).css('color', 'green'));
            } else {
                $('#mensajeCupon').text(res?.mensaje || 'Cupón no válido.').css('color', 'red');
            }
        });
    }

    function quitarCupon() {
        $.post(urlQuitarCupon, {}, function (res) {
            if (res && res.success) refreshCarritoPartial();
        });
    }

    // 🔹 Buscar clientes (inline)
    $('#btnBuscarCliente').on('click', function () {
        var termino = $('#txtBuscarCliente').val();
        var $cont = $('#resultadoClientes').empty();

        if (!termino) {
            $cont.html('<div class="text-muted">Ingrese un criterio de búsqueda.</div>');
            return;
        }

        $.get(urlBuscarCliente, { termino: termino }, function (res) {
            if (!res || !res.length) {
                $cont.html('<div class="text-muted">No se encontraron clientes.</div>');
                return;
            }

            var html = '<ul class="list-group">';
            res.forEach(function (c) {
                html += `
<li class="list-group-item d-flex justify-content-between align-items-center">
    <div>
        <strong>${c.NombreCompleto}</strong><br/>
        <small class="text-muted">Cédula: ${c.Cedula}</small>
    </div>
    <button class="btn btn-sm btn-success"
            onclick="seleccionarCliente(${c.IdCliente})">
        <i class="bi bi-check2"></i> Seleccionar
    </button>
</li>`;
            });
            html += '</ul>';

            $cont.html(html);
        });
    });

    $('#btnLimpiarClientes').on('click', function () {
        $('#txtBuscarCliente').val('');
        $('#resultadoClientes').empty();
    });

    function seleccionarCliente(idCliente) {
        $.post(urlSeleccionarCliente, { idCliente: idCliente }, function (res) {
            if (res && res.success) {
                refreshCarritoPartial();
            }
        });
    }

    // --- MODALES DE CONFIRMACIÓN Y MENSAJE ---
    const modalConfirmar = new bootstrap.Modal(document.getElementById('modalConfirmarVenta'));
    const modalMensaje = new bootstrap.Modal(document.getElementById('modalMensajeVenta'));
    const mensajeBody = document.getElementById('mensajeVentaBody');

    function mostrarMensajeVenta(mensaje) {
        mensajeBody.innerHTML = mensaje;
        modalMensaje.show();
    }


    $('#btnFinalizarVenta').on('click', function () {
        modalConfirmar.show();
    });

    $('#btnConfirmarVenta').on('click', function () {
        modalConfirmar.hide();
        $.post(urlFinalizarVenta, {}, function (res) {

            if (res && res.success) {
                let msg = res.mensaje || "Venta finalizada.";
                if (res.puntosMensaje) {
                    msg += "<br><small>" + res.puntosMensaje + "</small>";
                }

                mensajeBody.innerHTML = msg;
                modalMensaje.show();

                refreshCarritoPartial();
                $('#resultadoBusquedaProductos, #resultadoBusquedaServicios').empty();
                $('#resultadoClientes').empty();
            } else {
                mensajeBody.textContent = (res && res.mensaje) || "No se pudo completar la venta.";
                modalMensaje.show();
            }

        }).fail(() => {
            mensajeBody.textContent = "Error al conectar con el servidor.";
            modalMensaje.show();
        });
    });

    $(function () {
        attachCarritoEvents();
    });
</script>

<style>
    body {
        background-color: #fdfdfd;
    }

    .btn-buscar {
        background-color: #FFD60A;
        border: none;
        color: #1B263B !important;
    }

        .btn-buscar:hover {
            background-color: #F4C400;
            color: #000 !important;
        }

    .btn-agregar:hover {
        background-color: #FFC300 !important;
    }

    .table-hover tbody tr:hover {
        background-color: #FFF9E6 !important;
    }

    .btn:focus {
        box-shadow: none !important;
    }

    .nav-tabs .nav-link {
        color: #ffffff;
        border: none;
        border-radius: 8px 8px 0 0;
        background-color: transparent;
        transition: all 0.3s ease;
        font-weight: 600;
        padding: 0.75rem 1.5rem;
    }

        .nav-tabs .nav-link:hover {
            background-color: #243A57;
            color: #FFD60A;
        }

        .nav-tabs .nav-link.active {
            background-color: #FFD60A !important;
            color: #1B263B !important;
            border: none !important;
            border-radius: 10px 10px 0 0;
            box-shadow: inset 0 -2px 0 rgba(0,0,0,0.15);
        }
</style>
