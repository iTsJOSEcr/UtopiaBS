@model UtopiaBS.Web.ViewModels.VentaViewModel
@{
    ViewBag.Title = "Punto de Venta";
}

<h2>Punto de Venta</h2>

<div class="row">
    <div class="col-md-6">
        <h4>Buscar Producto</h4>
        <input type="text" id="txtBuscar" placeholder="Nombre o código" class="form-control" />
        <button class="btn btn-primary mt-2" onclick="buscarProducto()">Buscar</button>
        <ul id="resultadoBusqueda" class="list-group mt-2"></ul>
    </div>

    <div class="col-md-6">
        <h4>Carrito</h4>
        <table class="table table-bordered" id="tblCarrito">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Precio Unitario</th>
                    <th>Subtotal</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var linea in Model.Lineas)
                {
                    <tr data-id="@linea.IdProducto">
                        <td>@linea.NombreProducto</td>
                        <td><input type="number" value="@linea.Cantidad" min="1" onchange="actualizarCantidad(@linea.IdProducto, this.value)" /></td>
                        <td>@linea.PrecioUnitario.ToString("C")</td>
                        <td>@linea.SubTotal.ToString("C")</td>
                        <td><button class="btn btn-danger btn-sm" onclick="eliminarLinea(@linea.IdProducto)">Eliminar</button></td>
                    </tr>
                }
            </tbody>
        </table>
        <h5>Total: @Model.Total.ToString("C")</h5>
        <button class="btn btn-success mt-3" onclick="finalizarVenta()">Finalizar Venta</button>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
function buscarProducto() {
    var termino = $("#txtBuscar").val();
    $.get('@Url.Action("BuscarProducto", "Ventas")', { termino: termino }, function(res) {
        var html = "";
        res.forEach(function(p) {
            html += `<li class="list-group-item">
                        ${p.Nombre} - ${p.PrecioUnitario.toFixed(2)}
                        <button class="btn btn-sm btn-primary float-right" onclick="agregarCarrito(${p.IdProducto}, '${p.Nombre}', ${p.PrecioUnitario})">Agregar</button>
                    </li>`;
        });
        $("#resultadoBusqueda").html(html);
    });
}

function agregarCarrito(idProducto, nombre, precioUnitario) {
    $.post('@Url.Action("AgregarAlCarrito", "Ventas")', { idProducto, nombre, precioUnitario }, function(res) {
        if(res.success) location.reload();
    });
}

function actualizarCantidad(idProducto, cantidad) {
    $.post('@Url.Action("ActualizarLinea", "Ventas")', { idProducto, cantidad }, function(res) {
        if(res.success) location.reload();
    });
}

function eliminarLinea(idProducto) {
    $.post('@Url.Action("EliminarLinea", "Ventas")', { idProducto }, function(res) {
        if(res.success) location.reload();
    });
}

function finalizarVenta() {
    $.post('@Url.Action("FinalizarVenta", "Ventas")', {}, function(res) {
        if(res.success) {
            alert(res.mensaje);
            location.reload();
        } else {
            alert("Error al registrar la venta.");
        }
    });
}
</script>
