@model IEnumerable<UtopiaBS.ViewModels.ClienteMembresiaViewModel>

@{
    ViewBag.Title = "Panel de Membresías";
}

<!-- Bootstrap & Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

<div class="container py-5">
    <div class="card shadow-lg border-0 rounded-4 overflow-hidden">

        <!-- ENCABEZADO -->
        <div class="card-header d-flex justify-content-between align-items-center text-white"
             style="background-color:#1B263B;">
            <h3 class="mb-0 fw-bold">
                <i class="bi bi-stars me-2 text-warning"></i> Panel de Membresías de Clientes
            </h3>
        </div>

        <!-- CONTENIDO -->
        <div class="card-body" style="background-color:#F8FAFC;">

            <!-- MENSAJES -->
            @if (TempData["Success"] != null)
            {
                <div class="alert alert-success text-center fw-semibold rounded-3 shadow-sm py-2 mb-3">
                    <i class="bi bi-check-circle me-2"></i> @TempData["Success"]
                </div>
            }
            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger text-center fw-semibold rounded-3 shadow-sm py-2 mb-3">
                    <i class="bi bi-exclamation-octagon me-2"></i> @TempData["Error"]
                </div>
            }

            <!-- FILTRO POR CÉDULA -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <input type="text" id="filtroCedula"
                           class="form-control shadow-sm rounded-pill"
                           placeholder="🔍 Buscar por cédula...">
                </div>
            </div>

            <!-- TABLA -->
            <div class="table-responsive rounded-3 shadow-sm" style="max-height:550px; overflow-y:auto;">
                <table class="table table-hover align-middle text-center mb-0">
                    <thead class="text-white text-uppercase small" style="background-color:#1B263B;">
                        <tr>
                            <th>Cliente</th>
                            <th>Cédula</th>
                            <th>Tipo de Membresía</th>
                            <th>Estado</th>
                            <th>Inicio</th>
                            <th>Fin</th>
                            <th>Puntos</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>

                    <tbody id="tablaClientes">
                        @if (!Model.Any())
                        {
                            <tr>
                                <td colspan="8" class="text-muted py-3">
                                    No hay clientes con información de membresía
                                </td>
                            </tr>
                        }
                        else
                        {
                            foreach (var c in Model)
                            {
                    <tr>
                        <td class="fw-semibold">@c.Nombre</td>
                        <td>@c.Cedula</td>
                        <td>@c.TipoMembresia</td>

                        <td>
                            @if (c.Activa)
                            {
                                <span class="badge rounded-pill bg-success px-3 py-2">
                                    Activa
                                </span>
                            }
                            else
                            {
                                <span class="badge rounded-pill bg-secondary px-3 py-2">
                                    Inactiva
                                </span>
                            }
                        </td>

                        <td>
                            @c.FechaInicio.ToString("dd/MM/yyyy")
                        </td>

                        <td>
                            @(c.FechaFin != null
                              ? c.FechaFin.Value.ToString("dd/MM/yyyy")
                              : "—")
                        </td>


                        <td class="fw-bold">@c.Puntos</td>

                        <td class="d-flex gap-1 justify-content-center">

                            <!-- ASIGNAR / CAMBIAR -->
                            <a href="@Url.Action("Asignar", "Membresias", new { idCliente = c.IdCliente })"
                               class="btn btn-sm rounded-pill fw-semibold text-dark"
                               style="background-color:#FFD60A;"
                               title="Asignar / Cambiar">
                                <i class="bi bi-arrow-repeat"></i>
                            </a>

                            <!-- ACTIVAR / DESACTIVAR -->
                            <form method="post" action="@Url.Action("CambiarEstado", "Membresias")">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="idCliente" value="@c.IdCliente" />

                                <button type="submit"
                                        class="btn btn-sm rounded-pill fw-semibold @(c.Activa ? "btn-danger" : "btn-success")"
                                        title="@(c.Activa ? "Desactivar" : "Activar")">
                                    <i class="bi @(c.Activa ? "bi-x-circle" : "bi-check-circle")"></i>
                                </button>
                            </form>

                            <form method="post" action="@Url.Action("EnviarAlertasVencimiento", "Membresias")">
                                @Html.AntiForgeryToken()
                                <button type="submit"
                                        class="btn btn-warning rounded-pill fw-semibold">
                                    <i class="bi bi-envelope-exclamation"></i> Enviar Alertas de Vencimiento
                                </button>
                            </form>


                        </td>
                    </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>

        </div>
    </div>
</div>

<!-- FILTRO POR CÉDULA -->
<script>
    document.getElementById("filtroCedula").addEventListener("keyup", function () {
        let filtro = this.value.toLowerCase();
        let filas = document.querySelectorAll("#tablaClientes tr");

        filas.forEach(function (fila) {
            if (fila.cells.length > 1) {
                let cedula = fila.cells[1].innerText.toLowerCase();
                fila.style.display = cedula.includes(filtro) ? "" : "none";
            }
        });
    });
</script>

<style>
    body {
        background-color: #F1F5F9;
    }

    .table-hover tbody tr:hover {
        background-color: #E3F2FD;
    }

    .alert-success {
        border-left: 5px solid #198754;
    }

    .alert-danger {
        border-left: 5px solid #dc3545;
    }
</style>
