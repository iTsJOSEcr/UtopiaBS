@model IEnumerable<UtopiaBS.Entities.Cita>
@using UtopiaBS.Entities
@{
    ViewBag.Title = "Calendario de Citas";
    var empleados = ViewBag.Empleados as List<Empleado> ?? new List<Empleado>();
    var servicios = ViewBag.Servicios as List<Servicio> ?? new List<Servicio>();

    int? empleadoSeleccionado = ViewBag.EmpleadoSeleccionado != null ? (int?)ViewBag.EmpleadoSeleccionado : null;
    int? servicioSeleccionado = ViewBag.ServicioSeleccionado != null ? (int?)ViewBag.ServicioSeleccionado : null;
}

<div class="container mt-4">
    <h3 class="mb-4 text-center">📅 Calendario de Citas Disponibles</h3>

    <!-- FILTROS -->
    <form method="get" action="@Url.Action("Listar", "Cita")" class="row justify-content-center mb-4 g-2">
        <div class="col-md-4">
            <select class="form-select filtro" name="empleadoId" onchange="this.form.submit()">
                <option value="">👤 Filtrar por empleado</option>
                @foreach (var empleado in empleados)
                {
                    <option value="@empleado.IdEmpleado" @(empleadoSeleccionado == empleado.IdEmpleado ? "selected" : "")>
                        @empleado.Nombre
                    </option>
                }
            </select>
        </div>
        <div class="col-md-4">
            <select class="form-select filtro" name="servicioId" onchange="this.form.submit()">
                <option value="">💼 Filtrar por servicio</option>
                @foreach (var servicio in servicios)
                {
                    <option value="@servicio.IdServicio" @(servicioSeleccionado == servicio.IdServicio ? "selected" : "")>
                        @servicio.Nombre
                    </option>
                }
            </select>
        </div>
    </form>

    @if (TempData["Mensaje"] != null)
    {
        <div class="alert alert-info text-center py-2">@TempData["Mensaje"]</div>
    }

    <!-- TABLA -->
    <div class="table-responsive shadow-sm bg-white rounded" style="max-height: 420px; overflow-y: auto;">
        <table class="table table-hover table-striped align-middle text-center mb-0">
            <thead class="table-dark text-uppercase small">
                <tr>
                    <th>Fecha</th>
                    <th>Hora</th>
                    <th>Empleado</th>
                    <th>Servicio</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody>
                @if (!Model.Any())
                {
                    <tr>
                        <td colspan="5" class="text-muted small">No hay citas disponibles</td>
                    </tr>
                }
                else
                {
                    foreach (var cita in Model.OrderBy(c => c.FechaHora))
                    {
                        <tr>
                            <td>@cita.FechaHora.ToString("dd/MM/yyyy")</td>
                            <td>@cita.FechaHora.ToString("HH:mm")</td>
                            <td>@(cita.Empleado?.Nombre ?? "Sin asignar")</td>
                            <td>@(cita.Servicio?.Nombre ?? "Sin asignar")</td>
                            <td>
                                <button type="button" class="btn btn-success btn-sm reservar-btn"
                                        data-id="@cita.IdCita"
                                        data-fecha="@cita.FechaHora.ToString("dd/MM/yyyy")"
                                        data-hora="@cita.FechaHora.ToString("HH:mm")"
                                        data-empleado="@(cita.Empleado?.Nombre ?? "Sin asignar")"
                                        data-servicio="@(cita.Servicio?.Nombre ?? "Sin asignar")">
                                    Reservar
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<!-- MODAL DE CONFIRMACIÓN -->
<div class="modal fade" id="modalReserva" tabindex="-1" aria-labelledby="modalReservaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalReservaLabel">Confirmar Reserva</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>📅 Fecha:</strong> <span id="modalFecha"></span></p>
                <p><strong>⏰ Hora:</strong> <span id="modalHora"></span></p>
                <p><strong>👤 Empleado:</strong> <span id="modalEmpleado"></span></p>
                <p><strong>💼 Servicio:</strong> <span id="modalServicio"></span></p>
            </div>
            <div class="modal-footer">
                <form method="post" action="@Url.Action("Reservar", "Cita")" id="formReserva">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="idCita" id="inputIdCita" />
                    <input type="hidden" name="idCliente" value="1" />
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Confirmar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- JS -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const modal = new bootstrap.Modal(document.getElementById("modalReserva"));
        const fechaEl = document.getElementById("modalFecha");
        const horaEl = document.getElementById("modalHora");
        const empleadoEl = document.getElementById("modalEmpleado");
        const servicioEl = document.getElementById("modalServicio");
        const inputIdCita = document.getElementById("inputIdCita");

        document.querySelectorAll(".reservar-btn").forEach(btn => {
            btn.addEventListener("click", function () {
                fechaEl.textContent = this.dataset.fecha;
                horaEl.textContent = this.dataset.hora;
                empleadoEl.textContent = this.dataset.empleado;
                servicioEl.textContent = this.dataset.servicio;
                inputIdCita.value = this.dataset.id;

                modal.show();
            });
        });
    });
</script>

<style>
    .filtro {
        border-radius: 12px;
        padding: 6px 10px;
        font-size: 0.9rem;
        border: 1px solid #ced4da;
        background-color: #f8f9fa;
        transition: border 0.2s, box-shadow 0.2s;
    }

        .filtro:focus {
            border-color: #4e73df;
            box-shadow: 0 0 6px rgba(78, 115, 223, 0.5);
        }

    .btn-success {
        border-radius: 20px;
        padding: 5px 12px;
        font-size: 0.85rem;
        font-weight: 500;
    }
</style>
