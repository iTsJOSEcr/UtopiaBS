@model UtopiaBS.Entities.Contabilidad.CierreSemanal
@using System.Globalization

@{
    ViewBag.Title = "Cierre Semanal";
    var cr = new CultureInfo("es-CR");

    string inicioStr = Model != null ? Model.FechaInicio.ToString("yyyy-MM-dd") : "";
    string finStr = Model != null ? Model.FechaFin.ToString("yyyy-MM-dd") : "";
}

<div class="container py-5">
    <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
        <div class="card-header text-white d-flex align-items-center" style="background-color:#1B263B;">
            <h3 class="mb-0 fw-bold"><i class="bi bi-bar-chart-line-fill me-2"></i> Generar Cierre Semanal</h3>
        </div>

        <div class="card-body" style="background-color:#F8F9FA;">

            <!-- Mensaje -->
            @if (TempData["Mensaje"] != null)
            {
                <div class="alert alert-warning alert-dismissible fade show mt-3 shadow-sm" role="alert">
                    <i class="bi bi-exclamation-circle me-2"></i>
                    <strong>¡Aviso!</strong> @TempData["Mensaje"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }

            <!-- Formulario -->
            @using (Html.BeginForm("GenerarCierreSemanal", "Contabilidad", FormMethod.Post))
            {
                @Html.AntiForgeryToken()
                @Html.ValidationSummary(true, "", new { @class = "text-danger" })

                <div class="row g-4 mt-2">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold text-secondary">Fecha de inicio:</label>
                        <div class="input-group shadow-sm">
                            <input type="text" id="fechaInicio" name="inicio"
                                   class="form-control" placeholder="Seleccionar fecha..." required
                                   value="@inicioStr" autocomplete="off" />
                            <span class="input-group-text bg-info text-white"><i class="bi bi-calendar3"></i></span>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold text-secondary">Fecha de fin:</label>
                        <div class="input-group shadow-sm">
                            <input type="text" id="fechaFin" name="fin"
                                   class="form-control" placeholder="Seleccionar fecha..." required
                                   value="@finStr" autocomplete="off" />
                            <span class="input-group-text bg-info text-white"><i class="bi bi-calendar3"></i></span>
                        </div>
                    </div>
                </div>

                <div id="rangoFechas" class="text-center mt-3 fw-semibold text-secondary" style="display:none;"></div>

                <div class="mt-4 text-center">
                    <button type="submit" class="btn text-dark fw-semibold px-4 shadow-sm border-0" style="background-color:#FFD60A;">
                        <i class="bi bi-calendar-check-fill me-2"></i> Generar Cierre
                    </button>
                </div>
            }

            <!-- RESULTADOS -->
            @if (Model != null)
            {
                <div class="mt-5 p-4 rounded-3 shadow-sm" style="background-color:#FFFFFF;">

                    <!-- Encabezado visual -->
                    <div class="d-flex justify-content-center mb-4">
                        <div class="px-4 py-2 rounded-pill d-flex align-items-center shadow-sm" style="background-color:#E9F7FE; color:#1B263B;">
                            <i class="bi bi-calendar3 me-2 fs-5 text-info"></i>
                            <span class="fw-semibold">
                                Rango del cierre:
                                <span class="text-primary">@Model.FechaInicio.ToString("dd/MM/yyyy")</span>
                                al
                                <span class="text-primary">@Model.FechaFin.ToString("dd/MM/yyyy")</span>
                            </span>
                        </div>
                    </div>

                    <h4 class="fw-bold mb-4 text-center" style="color:#1B263B;">
                        📊 Cierre Semanal Generado
                    </h4>

                    <!-- Tabla fechas y balance -->
                    <div class="table-responsive">
                        <table class="table table-bordered align-middle text-center shadow-sm rounded-3 overflow-hidden">
                            <thead style="background-color:#E9F7FE;">
                                <tr class="fw-semibold text-secondary">
                                    <th style="width:33%;">Fecha inicio</th>
                                    <th style="width:33%;">Fecha fin</th>
                                    <th style="width:34%;">Balance</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>@Model.FechaInicio.ToShortDateString()</td>
                                    <td>@Model.FechaFin.ToShortDateString()</td>
                                    <td class="fw-bold" style="color:@(Model.Balance >= 0 ? "#198754" : "#C1121F")">
                                        ₡@Model.Balance.ToString("N2", cr)
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Tabla ingresos y egresos -->
                    <div class="table-responsive mt-4">
                        <table class="table table-bordered align-middle text-center shadow-sm rounded-3 overflow-hidden">
                            <thead style="background-color:#F9FCFF;">
                                <tr class="fw-semibold text-secondary">
                                    <th style="color:#198754;">Total Ingresos</th>
                                    <th style="color:#C1121F;">Total Egresos</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="fw-bold text-success fs-5">₡@Model.TotalIngresos.ToString("N2", cr)</td>
                                    <td class="fw-bold text-danger fs-5">₡@Model.TotalEgresos.ToString("N2", cr)</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Botones descarga -->
                    <div class="d-flex justify-content-center gap-3 mt-4">
                        <a href="@Url.Action("DescargarCierre", "Contabilidad", new { inicio = inicioStr, fin = finStr, formato = "excel" })"
                           class="btn text-dark fw-semibold border-0 shadow-sm px-4" style="background-color:#A8E6CF;">
                            <i class="bi bi-file-earmark-excel-fill me-1"></i> Descargar Excel
                        </a>

                        <a href="@Url.Action("DescargarCierre", "Contabilidad", new { inicio = inicioStr, fin = finStr, formato = "pdf" })"
                           class="btn text-white fw-semibold shadow-sm px-4" style="background-color:#E63946;">
                            <i class="bi bi-file-earmark-pdf-fill me-1"></i> Descargar PDF
                        </a>
                    </div>
                </div>
            }

            <!-- Volver -->
            <div class="mt-4 text-end">
                <a href="@Url.Action("Index", "Contabilidad")"
                   class="btn btn-outline-info fw-semibold px-4 shadow-sm">
                    <i class="bi bi-arrow-left-circle me-1"></i> Volver al Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Librerías -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/css/bootstrap-datepicker3.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/js/bootstrap-datepicker.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/locales/bootstrap-datepicker.es.min.js"></script>

<!-- Script de calendario -->
<script>
    $(function () {
        const $inicio = $('#fechaInicio');
        const $fin = $('#fechaFin');
        const $rango = $('#rangoFechas');

        $inicio.datepicker({
            format: 'yyyy-mm-dd',
            language: 'es',
            autoclose: true,
            todayHighlight: true,
            orientation: 'bottom auto',
            clearBtn: true
        });

        $fin.datepicker({
            format: 'yyyy-mm-dd',
            language: 'es',
            autoclose: true,
            todayHighlight: true,
            orientation: 'bottom auto',
            clearBtn: true
        });

        $inicio.on('changeDate', function (e) {
            $fin.datepicker('setStartDate', e.date);
            mostrarRango();
        });
        $fin.on('changeDate', mostrarRango);

        function mostrarRango() {
            const ini = $inicio.val();
            const fin = $fin.val();
            if (ini && fin) {
                $rango.text(`Rango seleccionado: del ${ini} al ${fin}`).fadeIn(200);
            } else {
                $rango.fadeOut(150);
            }
        }
    });
</script>

<!-- Estilos -->
<style>
    body {
        background-color: #fdfdfd;
    }

    .card {
        transition: 0.25s ease;
    }

        .card:hover {
            transform: translateY(-3px);
        }

    input.form-control {
        border: 2px solid #B6E0FE;
        background-color: #F9FCFF;
        border-radius: 10px;
    }

        input.form-control:focus {
            border-color: #0DCAF0;
            box-shadow: 0 0 5px rgba(13, 202, 240, 0.4);
        }

    .btn:hover {
        opacity: 0.9;
        transform: translateY(-2px);
    }

    .alert {
        font-size: 0.95rem;
    }
</style>
