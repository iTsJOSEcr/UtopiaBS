@{
    ViewBag.Title = "Nueva Contraseña";
}

<div class="login-light-card">
    <h3 class="text-center mb-4 fw-bold">@ViewBag.Title</h3>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger text-center rounded-3 shadow-sm mb-3">
            <i class="bi bi-exclamation-triangle-fill me-1"></i>
            @TempData["Error"]
        </div>
    }

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success text-center rounded-3 shadow-sm mb-3">
            <i class="bi bi-check-circle-fill me-1"></i>
            @TempData["Success"]
        </div>
    }

    @using (Html.BeginForm("ResetPassword", "Account", FormMethod.Post))
    {
        @Html.AntiForgeryToken()

        <!-- Datos importantes -->
        <input type="hidden" name="userId" value="@ViewBag.UserId" />
        <input type="hidden" name="token" value="@ViewBag.Token" />

        <!-- Indicador de requisitos -->
        <div class="mb-2">
            <small class="d-block mb-1 fw-semibold">Tu contraseña debe cumplir:</small>
            <ul id="passwordRequirements" class="list-unstyled small mb-3" aria-live="polite">
                <li id="req-length" class="text-danger">✖ Mínimo 10 caracteres</li>
                <li id="req-upper" class="text-danger">✖ Al menos 1 letra mayúscula (A-Z)</li>
                <li id="req-special" class="text-danger">✖ Al menos 1 carácter especial (ej. !@#$%)</li>
                <li id="req-match" class="text-danger d-none">✖ Las contraseñas no coinciden</li>
            </ul>
        </div>

        <label class="form-label fw-semibold">Nueva Contraseña</label>
        <input id="password" type="password" name="password" class="form-control mb-3"
               placeholder="********" required autocomplete="new-password" />

        <label class="form-label fw-semibold">Confirmar Contraseña</label>
        <input id="confirmPassword" type="password" name="confirmPassword"
               class="form-control mb-4" placeholder="********" required autocomplete="new-password" />

        <button id="submitBtn" type="submit" class="btn-main mb-3" disabled>
            <i class="bi bi-check-circle me-1"></i> Guardar nueva contraseña
        </button>

        <div class="text-center">
            <a href="@Url.Action("Login","Account")"
               class="btn btn-outline-secondary rounded-pill px-4">
                <i class="bi bi-arrow-left-circle"></i> Volver al inicio
            </a>
        </div>
    }
</div>

<style>
    .login-light-card {
        width: 390px;
        background: #ffffff;
        border-radius: 14px;
        padding: 35px;
        border: 1px solid #e6e6e6;
        box-shadow: 0 6px 15px rgba(0,0,0,0.08);
        margin: 50px auto;
    }

    .btn-main {
        background: #6a11cb;
        color: #fff;
        border-radius: 8px;
        width: 100%;
        border: none;
        padding: 10px 0;
        font-weight: 500;
        transition: 0.2s;
    }

        .btn-main:hover {
            background: #5712a8;
        }
</style>

@section Scripts {
    <script>
(function () {

    var pwd = document.getElementById('password');
    var cp = document.getElementById('confirmPassword');
    var btn = document.getElementById('submitBtn');

    var reqLength = document.getElementById('req-length');
    var reqUpper = document.getElementById('req-upper');
    var reqSpecial = document.getElementById('req-special');
    var reqMatch = document.getElementById('req-match');

    function setOk(el, text) {
        el.classList.remove('text-danger');
        el.classList.add('text-success');
        el.innerHTML = '✓ ' + text;
    }

    function setNotOk(el, text) {
        el.classList.remove('text-success');
        el.classList.add('text-danger');
        el.innerHTML = '✖ ' + text;
    }

    function check() {
        var v = pwd.value || '';
        var w = cp.value || '';

        var hasLength = v.length >= 10;
        var hasUpper = /[A-Z]/.test(v);
        var hasSpecial = /[^A-Za-z0-9\s]/.test(v);

        hasLength ? setOk(reqLength, 'Mínimo 10 caracteres')
                  : setNotOk(reqLength, 'Mínimo 10 caracteres');

        hasUpper ? setOk(reqUpper, 'Al menos 1 letra mayúscula (A-Z)')
                 : setNotOk(reqUpper, 'Al menos 1 letra mayúscula (A-Z)');

        hasSpecial ? setOk(reqSpecial, 'Al menos 1 carácter especial (ej. !@#$%)')
                   : setNotOk(reqSpecial, 'Al menos 1 carácter especial (ej. !@#$%)');

        if (w.length === 0) {
            reqMatch.classList.add('d-none');
        } else {
            reqMatch.classList.remove('d-none');
            v === w ? setOk(reqMatch, 'Las contraseñas coinciden')
                    : setNotOk(reqMatch, 'Las contraseñas no coinciden');
        }

        var allValid = hasLength && hasUpper && hasSpecial && (v === w);
        btn.disabled = !allValid;
    }

    pwd.addEventListener('input', check);
    cp.addEventListener('input', check);

    window.addEventListener('load', function () {
        setTimeout(check, 50);
    });

})();
    </script>
}
