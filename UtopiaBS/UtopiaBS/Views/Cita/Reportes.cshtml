@{
    ViewBag.Title = "Reportes de Citas";
}

<!-- Bootstrap, Icons y Chart.js -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.5/font/bootstrap-icons.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container py-5">
    <!-- TÍTULO -->
    <div class="text-center mb-4">
        <h2 class="fw-bold text-dark">
            <i class="bi bi-bar-chart-line text-warning me-2"></i> Reportes de Citas
        </h2>
        <p class="text-secondary">Genere reportes sobre el módulo de citas.</p>
    </div>

    <!-- TARJETA PRINCIPAL -->
    <div class="card shadow-lg border-0 rounded-4 mx-auto" style="max-width: 800px;">
        <div class="card-body px-5 py-4" style="background-color:#F8FAFC;">

            <!-- FORMULARIO -->
            <form id="reporteForm">
                <div class="row g-4 align-items-end">
                    <!-- FECHA INICIO -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold text-secondary">📅 Fecha Inicio</label>
                        <div class="input-group shadow-sm rounded-pill">
                            <span class="input-group-text border-0 bg-light rounded-start-pill">
                                <i class="bi bi-calendar-event text-primary"></i>
                            </span>
                            <input type="date" name="inicio" class="form-control border-0 rounded-end-pill" />
                        </div>
                    </div>

                    <!-- FECHA FIN -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold text-secondary">📅 Fecha Fin</label>
                        <div class="input-group shadow-sm rounded-pill">
                            <span class="input-group-text border-0 bg-light rounded-start-pill">
                                <i class="bi bi-calendar-check text-success"></i>
                            </span>
                            <input type="date" name="fin" class="form-control border-0 rounded-end-pill" />
                        </div>
                    </div>
                </div>

                <!-- BOTÓN DE ESTADÍSTICAS -->
                <div class="text-center mt-4">
                    <button type="button" id="btnVerEstadisticas"
                            class="btn fw-semibold text-white border-0 shadow-sm rounded-pill px-5 py-2"
                            style="background-color:#1B263B;">
                        <i class="bi bi-graph-up-arrow me-2"></i> Ver Estadísticas
                    </button>
                </div>
            </form>

            <!-- ALERTAS -->
            @if (TempData["Mensaje"] != null)
            {
                <div class="alert alert-info text-center mt-4 shadow-sm border-0 fw-semibold rounded-pill">
                    <i class="bi bi-info-circle me-2"></i> @TempData["Mensaje"]
                </div>
            }

            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger text-center mt-4 shadow-sm border-0 fw-semibold rounded-pill">
                    <i class="bi bi-exclamation-triangle me-2"></i> @TempData["Error"]
                </div>
            }

            <!-- SECCIÓN ESTADÍSTICAS -->
            <hr class="my-5" />
            <div id="estadisticasContainer" class="mt-4 text-center">
                <div id="estadisticasContenido" class="text-secondary">
                    <p>Seleccione un rango de fechas y presione "Ver Estadísticas".</p>
                </div>
            </div>

            <!-- SECCIÓN GRÁFICAS -->
            <div id="graficosContainer" class="mt-5" style="display:none;">
                <h4 class="fw-bold text-dark mb-4">
                    <i class="bi bi-pie-chart-fill text-primary me-2"></i>Visualizaciones
                </h4>
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card shadow-sm border-0">
                            <div class="card-body">
                                <h5 class="fw-semibold text-secondary mb-3 text-center">Citas por Profesional</h5>
                                <canvas id="graficoProfesional" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card shadow-sm border-0">
                            <div class="card-body">
                                <h5 class="fw-semibold text-secondary mb-3 text-center">Citas por Horario</h5>
                                <canvas id="graficoHorario" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BOTONES DE DESCARGA -->
            <div id="botonesDescarga" class="text-center mt-4" style="display:none;">
                <!-- BOTÓN PDF -->
                <button type="button" id="btnPdf"
                        class="btn fw-semibold text-white border-0 shadow-sm rounded-pill px-5 py-2 me-3 d-inline-flex align-items-center justify-content-center"
                        style="background-color:#D32F2F; transition: all 0.2s;">
                    <img src="https://cdn-icons-png.flaticon.com/512/337/337946.png"
                         alt="PDF" width="24" height="24" class="me-2">
                    Descargar PDF
                </button>

                <!-- BOTÓN EXCEL -->
                <button type="button" id="btnExcel"
                        class="btn fw-semibold text-white border-0 shadow-sm rounded-pill px-5 py-2 d-inline-flex align-items-center justify-content-center"
                        style="background-color:#217346; transition: all 0.2s;">
                    <img src="https://cdn-icons-png.flaticon.com/512/732/732220.png"
                         alt="Excel" width="24" height="24" class="me-2">
                    Descargar Excel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ESTILOS -->
<style>
    body {
        background-color: #F1F3F6;
    }

    .form-control {
        height: 45px;
        font-size: 0.95rem;
    }

    .btn {
        transition: all 0.2s ease-in-out;
    }

        .btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

    .alert-info {
        background-color: #E3F2FD;
        color: #0D47A1;
    }

    .alert-danger {
        background-color: #F8D7DA;
        color: #842029;
    }

    h2 {
        letter-spacing: 0.5px;
    }

    #estadisticasContenido {
        transition: opacity 0.6s ease, transform 0.6s ease;
    }

        #estadisticasContenido.fade {
            opacity: 0;
            transform: translateY(15px);
        }

    .color-item:hover {
        transform: scale(1.03);
        transition: all 0.2s ease;
    }
</style>

<script>
    const btnVerEstadisticas = document.getElementById("btnVerEstadisticas");
    const btnPdf = document.getElementById("btnPdf");
    const btnExcel = document.getElementById("btnExcel");

    let chartProfesional, chartHorario;
    let profesionalActual = null;

    // 🎨 Paleta estable de colores (reutilizable)
    const coloresProfesionales = [
        "#1B263B", "#118AB2", "#06D6A0", "#FFD166", "#EF476F", "#9C27B0", "#FF9800", "#2E8B57"
    ];

    // Efecto suave al actualizar contenido
    function smoothUpdate(element, callback) {
        element.classList.add("fade");
        setTimeout(() => {
            callback();
            element.classList.remove("fade");
        }, 400);
    }

    // ============================
    // CARGAR ESTADÍSTICAS
    // ============================
    function cargarEstadisticas(inicio, fin, profesional = null) {
        let url = `/Cita/Estadisticas?inicio=${inicio}&fin=${fin}`;
        if (profesional) url += `&profesionalNombre=${encodeURIComponent(profesional)}`;

        fetch(url)
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    document.getElementById("estadisticasContenido").innerHTML =
                        `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }

                const contenedor = document.getElementById("estadisticasContenido");
                smoothUpdate(contenedor, () => {
                    profesionalActual = profesional;

                    // === TÍTULO ===
                    let titulo = profesional
                        ? `<h4 class="fw-bold text-dark mb-3 animate__animated animate__fadeInDown">
                                <i class="bi bi-person-badge text-primary me-2"></i>
                                Estadísticas de ${profesional}
                           </h4>`
                        : `<h4 class="fw-bold text-dark mb-3 animate__animated animate__fadeInDown">
                                <i class="bi bi-graph-up text-success me-2"></i>
                                Estadísticas del período
                           </h4>`;

                    // === TARJETAS ===
                    let html = `
                        ${titulo}
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="card shadow-sm border-0 mb-3">
                                    <div class="card-body">
                                        <h5 class="text-primary fw-bold mb-3">📊 Totales por Estado</h5>
                                        <p><b>Agendadas:</b> ${data.TotalAgendadas}</p>
                                        <p><b>Completadas:</b> ${data.TotalCompletadas}</p>
                                        <p><b>Canceladas:</b> ${data.TotalCanceladas}</p>
                                        <p><b>Disponibles:</b> ${data.TotalDisponibles}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card shadow-sm border-0 mb-3">
                                    <div class="card-body">
                                        <h5 class="text-success fw-bold mb-3">👩‍⚕️ Citas por Profesional</h5>
                                        ${data.PorProfesional.map((p, i) => {
                        const color = profesional
                            ? (p.Profesional === profesional ? "#FFD166" : "#C0C0C0")
                            : coloresProfesionales[i % coloresProfesionales.length];
                        return `<p class="color-item"
                                                        style="color:${color}; font-weight:600; transition:all 0.3s ease;">
                                                        ${p.Profesional}: <b>${p.TotalCitas}</b>
                                                    </p>`;
                    }).join("")}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card shadow-sm border-0 mb-3">
                            <div class="card-body">
                                <h5 class="text-warning fw-bold mb-3">🕓 Citas por Horario</h5>
                                ${data.PorHorario.map(h => `<p>${h.Franja}: <b>${h.Total}</b></p>`).join("")}
                            </div>
                        </div>
                    `;

                    contenedor.innerHTML = html;
                    document.getElementById("botonesDescarga").style.display = "block";
                    document.getElementById("graficosContainer").style.display = "block";

                    const ctxProf = document.getElementById('graficoProfesional').getContext('2d');
                    const ctxHor = document.getElementById('graficoHorario').getContext('2d');

                    if (chartProfesional) chartProfesional.destroy();
                    if (chartHorario) chartHorario.destroy();

                    // === GRAFICO DE BARRAS ===
                    chartProfesional = new Chart(ctxProf, {
                        type: 'bar',
                        data: {
                            labels: data.PorProfesional.map(p => p.Profesional),
                            datasets: [{
                                label: 'Total de Citas',
                                data: data.PorProfesional.map(p => p.TotalCitas),
                                backgroundColor: data.PorProfesional.map((p, i) =>
                                    profesional && p.Profesional === profesional
                                        ? "#FFD166"
                                        : coloresProfesionales[i % coloresProfesionales.length]
                                ),
                                borderRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            animation: {
                                duration: 700,
                                easing: 'easeOutQuart'
                            },
                            onClick: (evt, elements) => {
                                const inicioVal = document.querySelector('input[name="inicio"]').value;
                                const finVal = document.querySelector('input[name="fin"]').value;

                                if (elements.length > 0) {
                                    const index = elements[0].index;
                                    const seleccionado = data.PorProfesional[index].Profesional;

                                    // 🔁 Si ya está seleccionado, vuelve al general
                                    if (profesionalActual === seleccionado) {
                                        profesionalActual = null;
                                        cargarEstadisticas(inicioVal, finVal);
                                    } else {
                                        cargarEstadisticas(inicioVal, finVal, seleccionado);
                                    }
                                } else if (profesionalActual) {
                                    profesionalActual = null;
                                    cargarEstadisticas(inicioVal, finVal);
                                }
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: { callbacks: { label: ctx => ` ${ctx.parsed.y} citas` } }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { precision: 0 }
                                }
                            }
                        }
                    });

                    // === GRAFICO DE PASTEL ===
                    chartHorario = new Chart(ctxHor, {
                        type: 'pie',
                        data: {
                            labels: data.PorHorario.map(h => h.Franja),
                            datasets: [{
                                data: data.PorHorario.map(h => h.Total),
                                backgroundColor: ['#FFD166', '#06D6A0', '#118AB2', '#EF476F']
                            }]
                        },
                        options: {
                            responsive: true,
                            animation: { duration: 700, easing: 'easeOutQuart' },
                            plugins: { legend: { position: 'bottom' } }
                        }
                    });
                });
            })
            .catch(err => {
                document.getElementById("estadisticasContenido").innerHTML =
                    `<div class="alert alert-danger">Error al cargar estadísticas.</div>`;
                console.error(err);
            });
    }

    // === EVENTOS ===
    btnVerEstadisticas.addEventListener("click", function () {
        const inicio = document.querySelector('input[name="inicio"]').value;
        const fin = document.querySelector('input[name="fin"]').value;
        if (!inicio || !fin) {
            alert("Seleccione ambas fechas para generar el reporte.");
            return;
        }
        cargarEstadisticas(inicio, fin);
    });

    btnPdf.addEventListener("click", () => descargarArchivo("pdf"));
    btnExcel.addEventListener("click", () => descargarArchivo("excel"));

    function descargarArchivo(formato) {
        const inicio = document.querySelector('input[name="inicio"]').value;
        const fin = document.querySelector('input[name="fin"]').value;
        if (!inicio || !fin) {
            alert("Seleccione ambas fechas antes de descargar.");
            return;
        }

        // Si hay un profesional filtrado, se añade al querystring
        const extraParam = profesionalActual
            ? `&profesionalNombre=${encodeURIComponent(profesionalActual)}`
            : "";

        window.location.href = `/Cita/DescargarReporteCitas?inicio=${inicio}&fin=${fin}&formato=${formato}${extraParam}`;
    }

</script>
